<html><head><title>Jan99: Threading Models and ActiveX Scripting</title></head><BODY BGCOLOR="#ffffff" TEXT="#000000" LINK="#0000ff" VLINK="#330066" ALINK="#FF0000">
<!--Copyright &#169; Dr. Dobb's Journal--><p><i>Dr. Dobb's Journal</i> January 1999 </p><h1>Threading Models and ActiveX Scripting</h1><HR><p>JScriptTest is single threaded. Most nontrivial ActiveX Scripting hosts, however, will use more than one thread and will therefore be either apartment or free threaded.</p><p>Both the JScript and VBScript engines are marked as "Both" threaded. This means that they can be used in either apartment- or free-threaded hosts without incurring any marshaling overhead. To make writing hosts simpler, the ActiveX Scripting specification defines some rules about which threads may call the scripting engine at which time. Specifically, hosts should:</p><ul><li>Choose a base thread (generally the thread that contains the message loop).  <li>Instantiate the scripting engine in the base thread.  <li>Call scripting engine methods only from the base thread, except where specifically allowed, as in the cases of <i>IActiveScript::InterruptScriptThread</i> and <i>IActiveScript::Clone</i>.  <li>Call the scripting engine's dispatch object only from the base thread.  <li>Ensure that the message loop runs in the base thread if a window handle is provided.  <li>Ensure that objects in the host's object model are only source events in the base thread.</ul><p>The documentation goes on to say "none of these restrictions apply to a host that chooses to implement a free-threaded <i>IActiveScriptSite</i> interface and a free-threaded object model. Such a host can use the <i>IActiveScript</i> interface from any thread, without restriction."</p><p>Unfortunately, this is not true for the current implementations of either JScript or VBScript. Calling any methods other than <i>IActiveScript::InterruptScriptThread</i> and <i>IActiveScript::Clone</i> from any thread other than the base thread will result in an error, even in a free-threaded host that implements a free-threaded <i>IActiveScriptSite</i>.</p><p>The reasoning behind this is efficiency. Scripts often interact with ActiveX controls, and these controls will often be apartment threaded. If the script engine could be called from any thread at any time, it would internally have to marshal all calls to such controls. If, however, it can guarantee that any individual script is called only on a single thread, no marshaling is necessary. This does, unfortunately, mean that hosts that want to call a single script from more than one thread will have to implement their own internal marshaling scheme to ensure adherence to the aforementioned rules.</p><p> -- P.B.</p><a href="9901d.htm#rs1">Back to Article</a><HR><I>Copyright &copy; 1999, Dr. Dobb's Journal</I><BR>
</body></html>