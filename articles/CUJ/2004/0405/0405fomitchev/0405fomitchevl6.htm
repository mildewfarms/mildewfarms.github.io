<html><head><title>May 04: </title></head><body BGCOLOR="#ffffff" LINK="#0000ff" VLINK="#330066" ALINK="#ff0000" TEXT="#000000"><!--Copyright &#169; C/C++ Users Journal--><h4>Listing 6:	<i>The</i> EnsureSession() <i>method.</i></h4><pre>HRESULT CUltraMaxService::EnsureSession(){    // Check session ID in SOAP header    if ( CString(m_Header.m_SessionID) != "" )    {        // Session cookie found: get current session        if ( FAILED(m_spSessionSvc-&gt;GetSession(                CString(m_Header.m_SessionID), &amp;m_spSession)) )            return E_FAIL;       // Make sure that session has not yet expired        if ( m_spSession-&gt;IsExpired() == S_OK )            return E_FAIL;    }    else    {        // No session cookie: create a new session        const size_t nCharacters = 64;        CHAR szID[nCharacters + 1] = "\0";        DWORD dwCharacters = nCharacters;        if ( FAILED(m_spSessionSvc-&gt;CreateNewSession(szID, &amp;dwCharacters,                &amp;m_spSession)) )            return E_FAIL;        // Store session ID in SOAP header        m_Header.m_SessionID = CComBSTR(szID).Detach();    }    return S_OK;}</body></html>