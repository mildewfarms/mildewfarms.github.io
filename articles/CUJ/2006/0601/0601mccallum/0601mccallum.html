<html><head><title>January, 2006: GNUAutoconf</title></head><body BGCOLOR="#ffffff" LINK="#0000ff" VLINK="#330066" ALINK="#ff0000" TEXT="#000000"><!--Copyright &#169; C/C++ Users Journal--><p><i>C/C++ Users Journal</i>, January 2006</p><h1>GNUAutoconf</h1><h2>A uniform means of creating makefiles at build time</h2><h3>By Ethan McCallum</h3><I>Ethan McCallum is a freelance technology consultant who spends a lot of time with Linux, C++, and Java. He can be reached at ethanqm@ penguinmail.com.</I><hr><p>Although we design software to be flexible and adaptable at runtime, our build processes are often still rigid&#151;once a project moves beyond the most trivial of examples or stub tests, changes to the build environment cause a snowball effect throughout the directory tree. Addressing headaches like this, GNU Autoconf (http://www.gnu.org/software/autoconf/) provides a uniform interface to creating your makefiles at build time. If you find yourself making predictable, repetitive changes to your build procedure to suit a given environment&#151;even through a homegrown sed/Perl tool&#151;Autoconf should help. </p><p>All but the most simple of software is driven by some sort of file or command-line parameters to control its behavior&#151;network listener ports, process owners, number of threads to spawn, and the like. Deferring such configuration from compile time to runtime provides tremendous flexibility to the program because the product of a single build is adaptable to myriad environments.</p><p>Autoconf encourages this adaptability within the build process by similarly deferring decisions until build time&#151;the location of supporting tools, flags for OS-specific compilers, installation directories, file ownership, and so on. Results of queries against the build host are merged with templates to create makefiles (actually, Autoconf can create any kind of file based on a template, but is typically used to create makefiles), and command-line tasks can be wrapped inside a tool such that you need not even remember to run them individually.</p><p>Having a clean, standard process to manage this is ideal for both developers and end users. (Raise your hand if you remember hand-editing makefiles and, in some cases, header files, to get a piece of software to build on your system.) An added benefit of letting Autoconf handle this sort of work is that it minimizes the chances of error introduced by human element; manual edits or lists of build procedures, for example.</p><p>If you frequently download and build open-source tools from source, chances are you are already familiar with Autoconf. Autoconf generates the <b>configure</b> of the configure/make/make-install routine. The <b>configure</b> process queries the host and uses its findings to bootstrap the makefiles, customizing them for the target build environment.</p><p>What may be surprising is that <b>configure</b> is a shell script&#151;and not a fancy shell script at that, just the most basic of Bourne shell syntax. Autoconf creates the <b>configure</b> script by expanding a series of m4 macros, as specified by users.</p><h3>Configure.ac</h3><p>Autoconf parses a file&#151;typically called "configure.ac"&#151;and expands any m4 macros it encounters. The macros are fragments of shell logic, which is why the resultant <b>configure</b> is a shell script. Similar to a preprocessor, anything Autoconf does not recognize as a macro it adds to <b>configure</b> untouched, which means a configure.ac could contain a mix of macros and raw shell code. Purists might eschew this notion, but the realists see this as a means to bootstrap Autoconf integration or perform a proof-of-concept. Over time, such quick-hit shell actions may be wrapped in proper m4 macros, so the lofty goal of a "pure" configure.ac can still be achieved. To introduce raw shell code into configure.ac is typically a precursor to writing your own site- or project-specific Autoconf macros.</p><p>The shell syntax to be used here is plain Bourne shell (/bin/sh)&#151;not C Shell, Korn Shell, or Bash, but very plain, portable Bourne shell. I emphasize the word "portable" because Bourne shells are not the same across all operating systems. </p><p>While the Autoconf manual says configure.ac must contain at minimum two specific Autoconf macros, you need three macro calls for Autoconf to be of any real use:</p><p>     </p><ul>  <li><b>AC_INIT</b> specifies the name and version of your package. Optionally, you can include an e-mail address for filing bug reports.  </li></ul><pre>AC_INIT([myproject], \	[3.5.1], \	[bugs-myproject@mydomain])</pre><ul>  <li>	  This information is included in <b>configure</b>'s help message and is available as expansion variables, which are what Autoconf uses to turn makefile templates into usable makefiles.</li>  <li><b>AC_CONFIG_FILES</b> lists the files <b>configure</b> creates at the end of its run. The filenames passed to <b>AC_CONFIG_FILES</b> need not exist&#151;in fact, they will be overwritten when <b>configure</b> runs&#151;but their templates most certainly should. A template is named for the file in question, plus a .in suffix. For example, in this call to <b>AC_CONFIG_FILES</b>:</li></ul><pre>AC_CONFIG_FILES([Makefile \	base/Makefile \	network/Makefile])</pre><ul>  <li>	the files Makefile.in, base/Makefile.in, and network/Makefile.in must exist relative to the location of the <b>configure</b> script.</li>  <li><b>AC_OUTPUT</b> performs variable substitution on the templates indicated by the call to <b>AC_CONFIG_FILES</b>. It takes no parameters.</li></ul><pre>	AC_OUTPUT</pre><p>The square brackets are included in the text. While some technical manuals have adopted the square brackets to indicate an optional parameter in examples, Autoconf (really, m4) sees them as quoting characters&#151;they act as boundaries such that values are not misinterpreted. I recommend that any parameter, other than a single word, be quoted.</p><p>Autoconf is also sensitive about spaces&#151;there should be no spaces between a square brace and the text it encloses, nor should there be space between a closing square brace and a following comma. In cases where you would like to move a value to the next line, use tabs instead of spaces.</p><h3>Creating Configure.ac</h3><p>Once you have a few Autoconf implementations under your belt, you will have the built-in macro names memorized and create configure.ac from scratch. For the neophytes (or, in my case, the forgetful), the Autoconf distribution includes the helper tool autoscan. Run autoscan at the base of your source tree and it recursively scans the directory structure for source and header files. The resultant configure.scan file is a template containing Autoconf macros relevant to header files, function calls, and compiler checks based on the scan of your source code. This file should be copied to configure.ac, which you would then customize.</p><p>Autoscan is not clairvoyant, however, so you must supplement its labor with some tests of your own. In fact, many macros (such as <b>AC_ARG_WITH</b>) are akin to abstract base classes in C++: They are not to be run as-is, but extended and customized with your own code. Some of the basic macros and output variables include:</p><ul>  <li><b>AC_PROG_CC</b> and <b>AC_PROG_CXX</b> check the command search path for a set of given C or C++ compilers, respectively. Once a particular compiler is located, set this value to the makefile variable <b>$CC</b> for C, or <b>$CXX</b> for C++. The entire list is quoted in m4 fashion, not individual elements:</li></ul><pre>	AC_PROG_CXX([ gcc3 , gcc , cc ])</pre><ul>  <li><b>AC_CHECK_TYPES</b> checks for each variable type in the list, defining the preprocessor macro <b>HAVE_{TYPE}</b> to "1" if found. Optionally, provide some shell code or m4 macros to run for either case of whether the type is found. If a list of header files is not provided as the fourth argument, the macro scans some predetermined system header files. </li></ul><pre>	AC_CHECK_TYPES(		[uid_t , struct stat SSL],		[true],		[AC_MSG_NOTICE([missing a key \		data type, this build may \		fail])]	)</pre><ul>  <li><b>AC_FUNC_MALLOC</b> and <b>AC_FUNC_REALLOC</b> check for the functions <b>malloc()</b> and <b>realloc()</b>, respectively.</li>  <li><b>AC_ARG_WITH</b> provides a framework to handle the <b>--with-{arg}</b> values passed to <b>configure</b> on the command line. The value passed via <b>--with-arg</b> is available as the shell variable <b>$withval</b>. The second argument is what is printed in <b>configure</b>'s help message; here I use the built-in <b>AC_HELP_STRING</b> macro to provide proper spacing and line wrapping such that the help message looks uniform:</li></ul><pre>	AC_ARG_WITH(		[ssl],		[AC_HELP_STRING([&#151;with-ssl], \		[provide the location of your \		SSL toolkit])],		[			## ... code to execute if \			## this flag is passed to 			## configure		],		[			## ... code to execute if \			## this flag is NOT passed \			## to configure		]	)</pre><ul>  <li>variable <b>@configure_input@</b> is a blanket warning that the file in question was generated by <b>configure</b>. When you see this, you should know to edit this file's Autoconf template (its .in file) and not the one you are currently reading.</li>  <li>variables <b>@CC@</b>, <b>@CXX@</b>, and <b>@CPP@</b> represent the C compiler, C++ compiler, and preprocessor, respectively.</li>  <li>variable <b>@target@</b> is the target system type in the canonical GNU format of <b>{cpu}-{vendor}-{os}</b>.</li></ul><p><a href="0601mccalluml1.html" target="_BLANK">Listing 1</a> is the full version of this macro. If users pass <b>--with-ssl=/some/path</b> to <b>configure</b>, it sets the output variables <b>@CXXFLAG_SSL@</b> and <b>@LDFLAG_SSL@</b> for C++ compiler and linker flags, respectively, based on the value of the <b>--with-ssl </b>flag; otherwise, the output variables are left blank.</p><p>Also note its deficiencies: You have to trust the user input (or lack thereof) to provide the location of a required library. If users omit the <b>--with-ssl</b> flag or provide an incorrect value, the build fails, perhaps at the tail end of a time-consuming compilation phase. It is preferable to catch such a problem during configure's tests. Autoconf has tools to attempt a sample compile/link process to confirm the availability of external headers and libraries.  </p><h3>Writing Custom Macros</h3><p>Autoconf's bundled macros suit a variety of purposes, and as such you may find yourself in need of some functionality specific to your project. Creating your own m4 macros to run through Autoconf is a straightforward affair, as long as you are familiar with shell programming and have a grasp of m4 quoting rules.</p><p>As previously stated, Autoconf macros use the most basic, portable Bourne shell syntax, and your homegrown macros should follow suit. If you use Autoconf solely for internal build purposes, you can probably get away with using shell constructs of Bourne derivatives (such as ksh and bash, but not csh or tcsh), but you would then have to explicitly invoke that shell when running <b>configure</b> (but this is strongly discouraged):</p><pre>ksh ./configure</pre><p>Just as Autoconf by default looks for its input in configure.ac, it seeks project-specific macros in a file named "aclocal.m4." (Autoconf also supports sitewide macros in a file called "acsite.m4," thus allowing you to create a hierarchy within your organization, much like a code library.)</p><p>In addition to shell fragments, your macro may also call existing macros. Common built-in macros of this sort include:</p><ul>  <li>Members of the <b>MSG_{type}</b> family print a message to the console, where <b>{type}</b> is one of <b>CHECKING</b>, <b>RESULT</b>, <b>ERROR</b>, <b>FAILURE</b>, <b>NOTICE</b>, or <b>WARN</b>. It is preferred that these facilities be used instead of using the shell's built-in <b>echo</b> command.</li>  <li><b>AC_SUBST</b> is used to make a value available as an output variable; that is, available in template files as <b>@variable_name@</b>. Be sure to properly quote (shell quote, not m4 quote) any values that have spaces or may be otherwise misinterpreted by the shell.</li></ul><p>Keep in mind, macros can do anything you could normally call from the shell; they need not necessarily check the target host or create any sort of output variable. For example, you could have some conditional logic that calls other macros based on the presence of a debug flag.</p><p>All good code should include comments, and Autoconf macros are no exception. Autoconf macros support two types of comments: Those lines beginning with "<b>#</b>" are ignored by Autoconf's macro expansion parsing but are included in the resultant <b>configure</b> script. Lines beginning with "<b>dnl</b>" are for quoting the m4 text itself, and are therefore omitted from <b>configure</b>.</p><p>Lastly, naming convention counts here. All of the built-in Autoconf macros' names begin with the prefix "<b>AC_</b>" so you should consider that reserved for Autoconf use to prevent clashes. For project-specific macros, you could name the prefix for the product's acronym. Sitewide Autoconf macros and variables (such as those you would see in acsite.m4 rather than aclocal.m4) could be named for your company or team. In these examples, I have chosen the generic <b>MYPROJECT_</b> prefix for all custom macros and variables.</p><p>To define a custom macro, call the macro <b>AC_DEFUN</b> from your aclocal.m4 file. <b>AC_DEFUN</b> takes the new macro's name and contents (body), quoted in m4 fashion, as its arguments:</p><pre>AC_DEFUN(	[MYPROJECT_MACRONAME],	[		## ... macro actions ...	])</pre><p><a href="0601mccalluml2.html" target="_BLANK">Listing 2</a> implements a custom Autoconf macro based on the built-in <b>AC_ARG_ENABLE</b> macro, which permits conditional inclusion of compile-time features based on whether the <b>--with-{feature}</b> flag is passed to <b>configure</b>. The feature in question is a compiler flag that enables runtime profiling.  </p><p>The macro in <a href="0601mccalluml2.html" target="_BLANK">Listing 2</a> uses the <b>AC_MSG_INFO</b> macro to communicate with the end user, rather than pure shell <b>echo</b> statements. This provides consistent output for the <b>configure</b> script. The results of the test are available in makefiles as the substitution variable <b>@CXXFLAGS_PROFILING@</b>, which will be either <b>-pg</b> or blank, based on whether the flag <b>--with-profiling</b> is passed to <b>configure</b>.</p><p><a href="0601mccalluml3.html" target="_BLANK">Listings 3</a> and <a href="0601mccalluml4.html" target="_BLANK">4</a> are a sample configure.ac and Makfefile.in, respectively, which include our custom macros from <a href="0601mccalluml1.html" target="_BLANK">Listings 1</a> and <a href="0601mccalluml2.html" target="_BLANK">2</a>. I intentionally used a basic makefile for brevity. For example, instead of creating makefile variables for the compiler flags, I include the Autoconf output variables inline with the compiler commands.  </p><p>Once you've written configure.ac, creating <b>configure</b> is a snap: Simply run <b>autoconf</b> in the directory where you have placed configure.ac (most likely at the root of your project's source tree). Be sure to rerun the command each time you update configure.ac, or your changes will not be incorporated into the <b>configure</b> script.</p><h3>Implementing Autoconf: Existing Projects</h3><p>There are myriad ways to integrate Autoconf into an existing build process. In all cases, it would behoove you to thoroughly review and, if necessary, clean up your existing build process before making any changes. This should reveal where you make your hand-edits, and which makefile definitions should be put under Autoconf control. In turn, this will make the initial Autoconf introductions brief, providing a relatively low downtime for your build process. If you already have a semiautomated process for performing your makefile substitutions, you could wrap that with Autoconf and phase it out over time.</p><p>Next, rename all files that will be updated by Autoconf such that they are recognized as templates: Add a .in suffix to their names. (Be sure to do this within your source control system as well.) Educate local development staff such that everyone understands that only changes to the template files will survive a source-code check-in. Include these filenames in the <b>AC_CONFIG_FILES</b> section of configure.ac. This way, from the start, each call to <b>configure</b> will create the target files.</p><p>Mark up the new templates using Autoconf output variable syntax <b>@variable_name@</b>. Be sure to review both the Autoconf manual and your aclocal.m4 to confirm the names of the output variables and the macros in which they are defined. At this point, if your build process is too delicate to call proper macros from configure.ac, your first version of this file can simply contain a series of <b>AC_SUBST</b> calls that use your default values. <a href="0601mccalluml5.html" target="_BLANK">Listing 5</a> includes an example of such a configure.ac.</p><p>In <a href="0601mccalluml5.html" target="_BLANK">Listing 5</a>, the call to <b>AC_CONFIG_FILES</b> uses tabs and newlines to separate its arguments for clarity. Also, the values passed to <b>AC_SUBST</b> are double quoted. Technically, only the <b>CFLAGS</b> substitution requires quotes, as its value contains a space; but to quote all values follows good shell form.</p><p>With the ability to perform variable substitutions, you can view your makefiles as a (limited) type of source code: "That macro is subject to change and is found in seven makefiles; let's put it under Autoconf."</p><h3>Implementing Autoconf: New Projects</h3><p>Using Autoconf in new projects (that is, making it part of the build process from the beginning) follows a path similar to integrating it into existing projects. Most likely the project will begin as stub code, so you can run autoscan on that to extract special headers or definitions you will use. From there, it becomes an iterative process: As the source tree grows, new directories are added, thus new files must be added to <b>AC_CONFIG_FILES</b>. If a new tool is required for a particular module, a new macro call is added to configure.ac (perhaps a custom macro is created in aclocal.m4) and the new output variables are added to that module's makefile. As part of release planning, further updates are made to configure.ac and the main makefile. In essence, Autoconf management can take on a life of its own, a project within your project. As time progresses, though, the Autoconf maintenance should subside even as the actual development moves along at full steam.</p><p>Some practices apply to both new and existing projects:</p><ul>  <li>Make a note of how Autoconf checks the build environment's architecture, and the form in which it reports the value. Keep a (static) list of architectures under which your product has been successfully built. When <b>configure</b> is run, make note of the architecture and let your end user know whether a compile has been attempted under this architecture before (that is, denote the chances of a successful build).</li>  <li>Keep an eye on future porting efforts: Provide reasonable defaults when the target host does not match any of your previous build specifications or, if this is not possible, create a means for <b>configure</b> to fail gracefully if it has not been built on this sort of platform before. If you do this, be sure to include another <b>configure</b> flag to override the failure/exit at this point.</li>  <li>Tailor Autoconf design to your expected mode of variance: If you port to a wide variety of architectures, then make your focus architecture dependencies.</li>  <li>Keep both configure.ac and <b>configure</b> in source control. This is especially helpful if you distribute your source code to customers or the general public: Such people need not have Autoconf installed on their machine to build your product as long as the <b>configure</b> script is available.</li></ul><h3>Using Autoconf </h3><p>Authors of open-source tools are acutely aware of varying build environments; it is no coincidence, then, that Autoconf drives the build process for so many open-source tools today. This needn't limit Autoconf to builds of open-source tools, however. Anyone who has ever designed a build environment for a multideveloper project can see the advantages of adaptable build-time configuration.  </p><p>All of this is good, but skeptics might raise an eyebrow: "Is all of this overkill for my project?" Perhaps, but not likely. If your project consists of a single makefile with definitions that never change, makes use of no external products/libraries, and you've never changed environments or compilers, then Autoconf probably is overkill. (Then again, who has a project like that and what are the chances it will remain as such?)</p><p>Even if Autoconf sounds like a great idea for your project, there are other considerations. From a technical standpoint, your first task is to determine whether Autoconf runs in your environment.  </p><p>Also consider the political ramifications, as determined by your team or company's stance toward free software. Some sites are wary of tools for which there are no explicit contracts, nor technical support contacts. To that, you may be able to quell management's fears by explaining Autoconf's ubiquity: It is part of the build process of a great number and wide variety of open-source packages, including the long-since-stable crowd of applications that are used, free of support contracts, every day in production environments.</p><p>Even then, you may want to have the local legal staff review the license such that they are aware of any sticking points. My understanding of the Autoconf license is that the <b>configure</b> script generated by the tool is not covered by the GNU Public License (GPL), nor is the code built by the process bootstrapped by <b>configure</b>; but it would still be to your advantage to have the license reviewed by a competent attorney.</p><p>Once you've confirmed Autoconf is right for you, the next hurdle is to implement it. There's no time like the present, and this article has provided some tips on integrating Autoconf into an existing project. As with the introduction of any widespread change, you must decide between "baby steps" and "leaps and bounds"; in other words, it comes down to how much disruption you can afford and how much confidence you have in the changes you make. There is no one true answer here. For the faint of heart, Autoconf's design supports an incremental introduction, in which most of the changes may take place behind the scenes.</p><h3>Conclusion</h3><p>Like most development tools, Autoconf requires an initial investment of time and effort, but as it takes care of some of the drudgework, the payoff is that you get to spend more time doing what you want to do in the first place&#151;write code. </p><p><b>CUJ</b></p></body></html>