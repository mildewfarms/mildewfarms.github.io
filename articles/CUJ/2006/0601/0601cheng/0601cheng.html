<html><head><title>January, 2006: Ch: A C/C++ Interpreter for Script Computing</title></head><body BGCOLOR="#ffffff" LINK="#0000ff" VLINK="#330066" ALINK="#ff0000" TEXT="#000000"><!--Copyright &#169; C/C++ Users Journal--><p><i>C/C++ Users Journal</i>, January 2006</p><h1>Ch: A C/C++ Interpreter for Script Computing</h1><h2>Interactive computing in C</h2><h3>By Harry H. Cheng</h3><I>Harry H. Cheng is a professor and director of the Integration Engineering Laboratory at the University of California, Davis. He is the Chief Architect of Ch, an embeddable C/C++ interpreter for script computing. He can be reached at hhcheng@ucdavis.edu.</I><hr><p>For some tasks, C and its compile/ link/execute/debug process are not productive. As computer hardware becomes cheaper and faster, to be productive and cost effective, script computing in C/C++ can be an appealing solution. To this end, we have developed Ch, an embeddable C/C++ interpreter for cross-platform scripting, shell programming, 2D/3D plotting, numerical computing, and embedded scripting [1].</p><p>As a complete C interpreter, Ch supports all language features and standard libraries of the ISO C90 Standard. It also supports an increasing number of C/C++ libraries including POSIX, TCP/IP socket, Winsock, Win32, X11/Motif, GTK+, OpenGL, ODBC, SQLite, CGI, LAPACK, LDAP, PCRE, Gnome Libxml2, Oracle XDK for XML, NAG statistics library, Intel OpenCV for computer vision, ImageMagick for image processing, SigLib for signal processing, and National Instruments' NI-DAQ and NI-Motion.</p><p>Ch supports most new features added in the ISO C99, such as complex numbers, variable length arrays (VLA), IEEE floating-point arithmetic, and type-generic mathematical functions. C programmers are encouraged to use these new features because they significantly simplify many programming tasks. Ch also supports classes in C++ for object-based programming.</p><p>Ch has borrowed features and ideas from many other languages and software packages. The following is a short list of other languages and software packages that, in one way or another, have influenced the development of Ch.</p><ul>  <li>Like the C shell, Ch can be used as a login shell and for shell programming. But, as a superset of C, Ch is a genuine C shell. </li>  <li>Like Basic, Ch is designed for, and has been used by, beginners who have no prior programming experience.</li>  <li>Like Perl, Ch has the built-in string and other features for text handling, and can be used for common gateway interface (CGI) applications in a web-server environment.</li>  <li>Like Java, Ch can be used for Internet computing. Safe Ch uses a sandbox model for security control. A Ch applet can be executed across a network on different computer platforms on the fly.</li>  <li>Like Tcl/TK, Ch can be embedded as a scripting engine in other applications and supports GTK+, Win32, and X/Motif for GUI development.</li>  <li>Like Fortran 90, Ch can be used for scientific computing.</li>  <li>Like MATLAB/Mathematica, Ch has computational arrays and can be used for numerical computing, graphical plotting, and rapid prototyping.</li></ul><p>The relationship of Ch to some of these languages and software packages is shown in <a href="0601chengf1.html" target="_BLANK">Figure 1</a>.</p><p>Unlike other languages and software packages, Ch bridges the gap between low-level languages and very high-level languages. As a superset of C, Ch retains low-level features of C such as accessing memory for hardware interface. However, unlike C, Ch can be considered a very high-level language (VHLL) environment. It makes hard things easy and easy things easier. Ch extends C with many high-level features such as string type and computational arrays as first-class objects, as in Fortran 90 and MATLAB for linear algebra and matrix computations. Ch supports shell programming with a built-in string type. Some problems, which might take thousands of lines of C code, can be easily solved with only a few lines of Ch code.</p><p>Furthermore, Ch is designed to be platform independent. It can run in a heterogeneous computing environment with different computer hardware and operating systems including Windows, Mac OS X, Linux in both Intel and PPC architectures, UNIX, FreeBSD, and QNX. A program developed on one platform can run on any other platform.</p><p>In this article, I will present some unique features offered by this C/C++ interpreter for script computing and illustrate how they are used in applications. Examples presented are portable across different platforms. One can readily try these examples by downloading Ch from http://www.softintegration.com/.</p><h3>Interactive Execution  Of C/C++ Statements  And Expressions</h3><p>I regularly teach engineering students on introductory computer programming in C. I use Ch interactively in classroom presentations using a laptop. Ch allows me to illustrate programming features quickly, especially in answering students' questions. Learners can also quickly try out different features of C without tedious compile/link/execute/debug cycles. To help beginners learn, Ch has been specially developed with many helpful warning and error messages, as an alternative to crashing with cryptic, arcane messages such as "segmentation fault" and "bus error."</p><p>All C statements and expressions can be executed interactively in a Ch command shell as shown in <a href="0601chengf2.html" target="_BLANK">Figure 2</a>. The output from the system resulting from executing an expression, statement, or command in Ch is displayed on the screen. For example, the output "Hello, world" can be obtained by calling function <b>printf()</b> interactively as shown in <a href="0601chengf2.html" target="_BLANK">Figure 2</a>. Note that the semicolon at the end of a statement in a C program is optional when the corresponding statement is executed in command mode. There is no semicolon in calling function <b>printf</b> in the previous execution. The default prompt in a Ch shell can be reconfigured. For simplicity, I'll only show the prompt <b>&gt;</b> in a Ch command shell for the rest of this article.</p><p>If a C expression is typed in, it will be evaluated by Ch. The result will then be displayed on the screen. For example, if the expression <b>1+3*2</b> is typed in, the output will be 7, as shown:</p><pre>&gt; 1+3*2 7</pre><p>Any valid C expression can be evaluated in a Ch shell. Therefore, Ch can be conveniently used as a calculator. As another example, one can declare a variable at the prompt, then use the variable in the subsequent calculations:</p><pre>&gt; int i &gt; sizeof(int) 4 &gt; i = 30 30 &gt; printf("%x", i) 1e &gt; printf("%b", i) 11110 &gt; i = 0b11110 30 &gt; i = 0x1E 30 &gt; i = -2 -2 &gt; printf("%b", i) 11111111111111111111111111111110 &gt; printf("%32b", 2) 00000000000000000000000000000010 </pre><p>In these C statements, variable <b>i</b> is declared as <b>int</b> type with 4 bytes. Then, the integer value 30 for <b>i</b> is then displayed in decimal, hexadecimal, and binary numbers. The integral constants in different number systems can also be assigned to variable <b>i</b>. The 2's complement representation of the negative number -2 is displayed as well. Characteristics for all other data types in C can also be presented interactively. Different format specifiers for the families of input function <b>fscanf()</b> and output function <b>fprintf()</b> using file streams opened by function <b>fopen()</b> can also be tried out this way. All C operators can be used interactively: </p><pre>&gt; int i=0b100, j = 0b1001 &gt; i &lt;&lt; 1 8 &gt; printf("%b", i|j) 1101 </pre><p>The concept of pointers and addresses of variables can be illustrated as shown: </p><pre>&gt; int i=10, *p &gt; &amp;i 1eddf0 &gt; p = &amp;i 1eddf0 &gt; *p 10 &gt; *p = 20 20 &gt; i 20 </pre><p>In this example, the variable <b>p</b> of the pointer to <b>int</b> points to the variable <b>i</b>. The relation of arrays and pointers can be illustrated as follows:</p><pre>&gt; int a[5] = {10,20,30,40,50}, *p; &gt; a 1eb438 &gt; &amp;a[0] 1eb438 &gt; a[1] 20 &gt; *(a+1) 20 &gt; p = a+1 1eb43c &gt; *p 20 &gt; p[0] 20 </pre><p>Expressions <b>a[1]</b>, <b>*(a+1)</b>, <b>*p</b>, and <b>p[0]</b> all refer to the same element. Multidimensional arrays can also be handled interactively. The boundary of an array is checked in Ch to detect potential bugs; see <a href="0601chenge1.html" target="_BLANK">Example 1</a>.</p><p>The allowed indices for array <b>a</b> of five elements are from 0 to 4. Array <b>s</b> can only hold five characters including a null character. Ch can catch bugs of existing C code related to the array boundary overrun. The alignment of a C structure or C++ class can also be examined as shown:</p><pre>&gt; struct tag {int i; double d;} s &gt; s.i =20 20 &gt; s .i = 20 .d = 0.0000 &gt; sizeof(s) 16 </pre><p>In this example, although the sizes of <b>int</b> and <b>double</b> are 4 and 8, respectively, the size of structure <b>s</b> with two fields of <b>int</b> and <b>double</b> types is 16, instead of 12, for the proper alignment.</p><h3>Interactive and Interpretive Execution  Of C/C++ Functions and Programs </h3><p>Not only C statements and expressions, but also C functions and programs, can be interactively executed in Ch. All functions in the C Standard Libraries can be executed interactively and used inside user-defined functions. For example, in <a href="0601chenge2.html" target="_BLANK">Example 2</a>, the random-number generator function <b>rand()</b> is seeded with a time value in <b>srand(time(NULL)</b>. Function <b>add()</b>, which calls type-generic mathematical function <b>sin()</b>, is defined at the prompt and then used. A function can also be invoked from a function file. A function file in Ch is a file with the extension .chf that contains only one function definition. The names of the function file and function definition inside the function file must be the same. A function is searched based on the search paths in the system variable <b>_fpath</b> for function files. The system variables can be set up in the startup configuration file .chrc for UNIX and _chrc in Windows in the user's home directory. For example, <a href="0601chengl1.html" target="_BLANK">Listing 1</a> is the function file addition.chf for function <b>addition()</b>. If file addition.chf is located in a directory specified in _<b>fpath</b>, function <b>addition()</b> can be used inside a program or command line:</p><pre>&gt; int i = 10 &gt; i = addition(10, i) 20 </pre><p>All functions, including function <b>main()</b>, in C are at the same level; functions cannot be defined inside other functions. In other words, there are no internal procedures in C. Ch extends C with nested functions. A function can define other functions inside itself. For example, the nested function <b>nestedfunc()</b> defined in <a href="0601chengl2.html" target="_BLANK">Listing 2</a> can be executed interactively as follows: </p><pre>&gt; nestedfunc(10, 20) 60 </pre><p>where function <b>innerfunc()</b> is defined inside function <b>nestedfunc()</b>. With nested functions, details of one functional module can be hidden from the other modules that do not need to know about them. Each module can be studied independent of others. Software maintenance is the major cost of a program. People who were not involved in the original design often do the most program maintenance. Nested functions modularize a program, thus clarifying the whole program and easing the pain of making changes to modules written by others. Nested functions are useful for information hiding and modular programming. They are complementary to data encapsulation in object-oriented programming in C++. In some applications, using nested functions is simpler than using member functions of classes.</p><p>Classes and some other C++ features are also supported in Ch for interactive execution of C++ code, as shown in <a href="0601chenge3.html" target="_BLANK">Example 3</a>. The input and output can be handled using <b>cin</b> and <b>cout</b> in C++. The public method <b>tagc::set()</b> sets the private member field <b>m_i</b>, whereas the public method <b>tagc::get()</b> gets its value. The argument of method <b>tagc::get()</b> is passed by reference. The size of the class <b>tagc</b> is 4 bytes, which does not include the memory for member functions.</p><p>C/C++ programs can also be executed interactively without compilation. For example, to run the program hello.c in <a href="0601chengl3.html" target="_BLANK">Listing 3</a>, one can type the command hello.c in a Ch command shell to get the output of "Hello, world":</p><pre>&gt; hello.c Hello, world </pre><p>Ch finds executable commands in directories specified in the system variable <b>_path</b>. From other command shells, program hello.c can be executed in Ch without compilation, as follows:</p><pre>% ch hello.c </pre><p>C/C++ programs can also run in Ch from an Integrated Development Environment (IDE) with a graphical user interface (GUI). Many IDEs, including the open-source ChSciTE IDE shown in <a href="0601chengf3.html" target="_BLANK">Figure 3</a>, support Ch by default. ChSciTE has a native graphical user interface in more than 30 localized languages.</p><p>To speed up interpretive execution of a C program, one should try to avoid loops in the program. For scientific numerical computations, one can use computational arrays for fast execution of algorithms with arrays. Alternatively, the code that is computationally intensive in a script program can be compiled as a binary module. In general, you may find it is necessary to interface binary modules in the following situations:</p><ul>  <li>The source code of a C/C++ library is not available. </li>  <li>To run Ch scripts fast by making the frequently called underlying C/C++ functions a binary library. </li>  <li>To protect the intellectual property and source code from being revealed. </li></ul><p>The Ch Software Development Kit (SDK) included in the distribution of Ch allows C/C++ scripts (Ch scripts) to interface C/C++ binary libraries without recompilation. C functions <b>dlopen()</b>, <b>dlsym()</b>, <b>dlerror()</b>, <b>dlclose()</b>, and Ch extension function <b>dlrunfun()</b> are used to dynamically load binary modules. They allow Ch scripts to access global variables or call functions in the compiled C/C++ libraries such as static library, shared library, or dynamically linked library (DLL). Ch scripts can callback Ch functions from C/C++ libraries. There is no distinction between the interpreted and compiled code.</p><p>The Ch SDK provides a utility to generate wrappers for Ch to interface C/C++ libraries automatically. Ch SDK has been effectively used to interface with Standard C Libraries such as POSIX, X11/Motif, Win32, GTK+, OpenGL, and ODBC.</p><p>The interpretive execution of C functions and programs is suitable for applications that do not take very much CPU time. Unlike other scripting languages, as a superset of C, Ch is particularly suitable for applications that need to interface to hardware, such as automated hardware testing and diagnosis.</p><p>The interpretive execution of C functions and programs is ideal for rapid prototyping. Programs can first be developed and tested in Ch. Later, the same code can be compiled in a C or C++ compiler for final production. Applications with tens of thousands of lines using functions in libraries such as POSIX, X11/Motif, Win32, GTK+, OpenGL, and ODBC can also effectively run in Ch.</p><p>The program compilation presents a serious problem for real-time manipulation of mechatronic systems. For real-time mechatronic systems, the external environment may be different at each execution, so the testing scenario may not be repeatable. During debugging and testing, it is impractical to restart a program from the very beginning every time a change is made or a problem is diagnosed. Ch is time deterministic. It can be used for control of mechatronic systems such as robotics. In a typical real-time application in RTLinux, a hard real-time module runs in the Linux kernel; Ch runs in the user space and communicates with the real-time module through interprocess communication such as FIFO.</p><p>The interpretive execution of C programs is especially suitable for interactive presentations using a laptop in a classroom with a quick response. With an interactive computing environment, instructors can relieve themselves from tedious compile/link/execute/debug cycles, and focus on teaching the knowledge and problem-solving skills. All sample code in a textbook for teaching computer programming in C can readily run in Ch without modification.</p><p>Ch is especially suitable for developing web-based interactive content in engineering and science for general applications and distance learning. For example, web-based design and analysis of control systems and mechanisms have been developed and they are available online at http://www.softintegration.com/ webservices/. The shopping cart on this site was also developed in Ch.</p><h3>Conclusion </h3><p>Ch is a complete C interpreter. It supports most new features added in C99 and classes in C++. Ch is embeddable in other applications as a C/C++ scripting engine. It is ideal for cross-platform scripting, shell programming, 2D/3D plotting, numerical computing, and embedded scripting. C/Ch/C++ allow users to use one language, anywhere and everywhere, for any programming tasks. Ch lowers the barrier for system programmers to do scripting. Whether you are a novice computer user or experienced C/C++ programmer, I hope that Ch will make your programming tasks more enjoyable.</p><h3>Acknowledgment </h3><p>I would like to thank Tom MacDonald for his suggestions and comments on this article.</p><h3>Reference </h3><ol>  <li>Ch: An Embeddable C/C++ Interpreter, http://www.softintegration.com/. </li></ol><p><b>CUJ</b></p></body></html>