<!DOCTYPE HTML PUBLIC "-//IETF//DTD HTML 4.0//EN">


<HTML>
<HEAD>
<TITLE>v11, i02: About Listing 2</TITLE>
<LINK REL=StyleSheet HREF="../../resource/css/sacdrom.css" TYPE="text/css" TITLE="CSS1">
</HEAD>

<body bgcolor="#ffffff" text="#000000" link="#000000" alink="#669999" vlink="#333366" topmargin=0 leftmargin=0>

<! -- Begin MASTER TABLE -- >
<!center>
<table width=98% cellpadding=0 cellspacing=0 border=0 bgcolor="#ffffff">
  <tr>

<table cellpadding=5 cellspacing=0 border=0>
	<tr>

		<td><span class="navbarLink"><a href="a8.htm">Article</a></span></td>
		<td><span class="navbarLink"><a href="a8_l1.htm">Listing 1</a></span></td>
		<td><span class="navbarLink"><a href="a8_l2.htm">Listing 2</a></span></td>
		<td><span class="navbarLink"><a href="a8_l3.htm">Listing 3</a></span></td>
		<td><span class="navbarLink"><a href="a8_s1.htm">Sidebar 1</a></span></td>
	</tr>
	<tr>
		<td><span class="navbarLink">Sidebar 2</span></td>
		<td><a href="../../../../source/SA/2002/feb2002.tar"><b class=codeListing></b></a></td>

	</tr>
</table>


</tr>
<tr>
<! -- Begin Content ------ >
    <td valign=top width=527 bgcolor="#ffffff"> 
      <table width=100% cellpadding=15 cellspacing=0 border=0>
<tr>
          <td valign=top> 
            <! -- Insert Content ------ >
            <H1>About Listing 2</h1>
            <p> In this script, we first define all the required variables on 
              lines 15 to 74, which includes strings, integers, floating point 
              numbers, and file/directory handles. Implement a <b>while()</b> 
              loop on lines 94 through 295 to calculate the current size of each 
              database directory. In this loop, use the <b>readdir()</b> function 
              for scanning through the directories, and then <b>stat()</b> for 
              getting the size of each file. The file sizes are added to size 
              on line 159 so that when the nested <b>while()</b> loop ends on 
              line 161, size holds the complete size for the currently scanned 
              directory (in bytes). However, it's not very nice to present 
              the results of the quota checking in bytes, so size is converted 
              to megabytes at line 173.
            <p> We must retrieve the maximum allowed database size from some source 
              in order to make use of this information. Fortunately, when we set 
              up the database, we also create a file in which we specify the maximum 
              size for the specific database in megabytes. The name of this file 
              is always the same as the database name or username. Lines 179 through 
              194 open the quota file for the currently scanned database and save 
              the information stored in the quota file in the variable quota.
            <p> Line 216 checks whether the quota was exceeded. If so, the code 
              inside the <b>if()</b> statements on line 216 through 264 are executed. 
              We also check whether there's a file called <b>$DB_NAME_reported</b> 
              (known as the reported file) in the <b>$MYSQL_BASE_DIR/quota</b> 
              directory. If not, the <b>$DB_NAME_reported</b> file will be created, 
              and an email will be sent to the admin (daniel@solin.org, in this 
              case) reporting that this particular database exceeded its quota. 
              On the other hand, if the file already exists, it means that the 
              problem has already been reported and should not be reported again. 
              If we skipped this feature, the result would be that an email would 
              be sent every time the quota was checked (in this case, every two 
              seconds).
            <p> Lines 273 through 294 provide another nice feature that makes 
              sure that when a reported file exists for a database but the quota 
              for it is no longer exceeded, the program assumes that the quota 
              problem has been resolved and subsequently removes the quota file. 
              It then sends an email to the administrator and reports that the 
              problem has been fixed. In reality, "fixing the quota problem" 
              simply means that database size has decreased, or the maximum size 
              has been increased in the database's corresponding quota file.
          </table></table>&nbsp;

<! -- End Content ------ >

<!/center>
<! -- End MASTER TABLE -- >

</body>



<! -- Begin Content ------ >
</html>
