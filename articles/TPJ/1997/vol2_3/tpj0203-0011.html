<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>MakeMaker: Doing More While Doing Less - The Perl Journal, Fall 1997</title>
  <meta name="generator" content=
  "HTML Tidy for Linux/x86 (vers 12 April 2005), see www.w3.org">
  <meta name="vscategory" content="Perl">
  <meta name="vsisbn" content="">
  <meta name="vstitle" content=
  "MakeMaker: Doing More While Doing Less">
  <meta name="vsauthor" content="Randy J. Ray">
  <meta name="searchdescription" content=
  "MakeMaker might well be the most-used module in the core Perl distribution. It creates a Makefile for extensions you build, so that they can be compiled and installed by other people on other platforms. MakeMaker insulates you from the vagaries of different operating systems such as compiler flags or how dynamic libraries are constructed. It frees you to focus on the module itself rather than the installation process. If you're writing a module that will be distributed on the CPAN, or that needs to run on more than one architecture, MakeMaker is essential. This article assumes knowledge of basic configuration issues and the make command.">
  <meta name="vsimprint" content="The Perl Journal">
  <meta name="vspublisher" content="Earthweb">
  <meta name="vspubdate" content="Fall 1997">
  <!-- always update the article title and issue -->

</head>

<body>
  <font face="verdana" size="1">Issue 7, Fall 1997</font>

  <h2 align="center">MakeMaker: Doing More While Doing Less</h2>

  <h4><i>Randy J. Ray</i></h4>
  <!-- packages described, if necessary -->
  <font size="+2">M</font>akeMaker might well be the most-used
  module in the core Perl distribution. It creates a Makefile for
  extensions you build, so that they can be compiled and installed
  by other people on other platforms. MakeMaker insulates you from
  the vagaries of different operating systems such as compiler
  flags or how dynamic libraries are constructed. It frees you to
  focus on the module itself rather than the installation process.
  If you're writing a module that will be distributed on the CPAN,
  or that needs to run on more than one architecture, MakeMaker is
  essential. This article assumes knowledge of basic configuration
  issues and the make command.

  <p>MakeMaker is the colloquial name for the ExtUtils::MakeMaker
  module. When loaded, it imports a set of core routines and a
  platform-specific library of routines. UNIX platforms are all
  alike to MakeMaker, since the Perl configuration process will
  already have identified the relevant differences between them
  Thanks to MakeMaker, packages as operating-system-dependent as
  Perl/Tk will automatically build on platforms as diverse as VMS,
  Windows 95, and O/S 2.</p>

  <h3>From The Beginning: h2xs</h3>

  <p>The h2xs program bundled with the Perl distribution, is
  indispensable for module developers. Although it was designed
  primarily for creating an extension framework from a C header
  file, it's flexible enough to serve the needs of most modules
  whether or not they use C.</p>

  <p>h2xs creates a basic .pm file, a MANIFEST file, a Changes
  file, a simple test.pl script, and most importantly, a skeletal
  Makefile.PL. Here's the Makefile.PL generated by h2xs -n
  Test:</p>
  <pre>
use ExtUtils::MakeMaker; 
# See lib/ExtUtils/MakeMaker.pm for details of how to influence
# the contents of the Makefile that is written. 
WriteMakefile( 
    'NAME'      =&gt; 'Test', 
    'VERSION_FROM' =&gt; 'Test.pm', # finds $VERSION 
    'LIBS'      =&gt; [''],   # e.g., '-lm' 
    'DEFINE'    =&gt; '',     # e.g., '-DHAVE_SOMETHING' 
    'INC'       =&gt; '',     # e.g., '-I/usr/include/other'
); 
</pre>

  <p>There's not much here, but what little there is does a great
  deal. It contains the information necessary to have
  ExtUtils::MakeMaker obtain the release version from your .pm
  file, notice whether your module uses XS (to link in C or C++
  code), build shared libraries from compiled code, create a
  distribution tar file, and more. (The above snippet affects both
  Test.pm and Test.xs. Invoking <i>h2xs</i> with the <tt>-X</tt>
  option would have suppressed the XS aspects and removed
  references to Test.xs from Test.pm.)</p>

  <p>Consider using <i>h2xs</i> even if your module or extension
  makes no use at all of XS code; MakeMaker is easily tamed with
  it. Read the <i>h2xs</i> documentation for more information.</p>

  <p>On to the components of the file itself.</p>

  <h3>Piece by Piece</h3>

  <p>MakeMaker allows people who download your module to prepare
  for compilation with one command: perl Makefile.PL.</p>

  <p>Ideally, this results in a module (or extension) that compiles
  without problems and can be merged seamlessly with the user's
  existing Perl installation.</p>

  <p>Makefile.PL is a Perl script, but it can't make any
  assumptions about, say, where your Perl executable is. Thus, it
  immediately imports the <tt>ExtUtils::MakeMaker</tt> module. The
  rest of the module is merely a call to that module's
  <tt>WriteMakefile()</tt> subroutine. <tt>WriteMakefile()</tt> is
  given some basic attributes of your extension: its name, the
  version number (if any), and whether extra libraries,
  compile-time definitions, or include paths are needed. Other
  attributes can be supplied; five of the most common are listed
  below. See the ExtUtils::MakeMaker documentation for the complete
  list.</p>

  <div align="center">
    <table cellpadding="2" cellspacing="2" width="500" border="1">
      <tr valign="top">
        <td><i>Attribute</i></td>

        <td><i>What to pass</i></td>

        <td><i>What it does</i></td>
      </tr>

      <tr valign="top">
        <td><tt>CONFIGURE</tt></td>

        <td>Code reference</td>

        <td>The code reference is executed, and is expected to
        return a hash reference with other attributes for Makefile
        generation.</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLSCRIPT</tt></td>

        <td>Scalar</td>

        <td>The installation directory for scripts.</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLSITELIB</tt></td>

        <td>Scalar</td>

        <td>The installation directory for libraries. This assumes
        that you're not building within the Perl distribution; it
        defaults to the site_lib set when Perl was built.</td>
      </tr>

      <tr valign="top">
        <td><tt>PL_FILES</tt></td>

        <td>Hash reference</td>

        <td>Maps .PL files to their full filenames.</td>
      </tr>

      <tr valign="top">
        <td><tt>PREREQ_PM</tt></td>

        <td>Hash reference</td>

        <td>A list of modules required for this module to work,
        such as Fcntl for SDBM_File. The hash should map module
        names to the version number you need.</td>
      </tr>
    </table>
  </div>

  <p>If you provide the following attributes to
  <tt>WriteMakefile()</tt>, the appropriate Makefile commands will
  be generated:</p>

  <div align="center">
    <table cellpadding="2" cellspacing="2" width="500" border="1">
      <tr valign="top">
        <td><i>Attribute</i></td>

        <td><i>What to pass</i></td>

        <td><i>What it does</i></td>
      </tr>

      <tr valign="top">
        <td><tt>clean</tt></td>

        <td>Hash reference</td>

        <td>The key FILES should map to an anonymous list of files
        to be removed during make clean.</td>
      </tr>

      <tr valign="top">
        <td><tt>realclean</tt></td>

        <td>Hash reference</td>

        <td>As above, for make realclean.</td>
      </tr>

      <tr valign="top">
        <td><tt>dist</tt></td>

        <td>Hash reference</td>

        <td>Contains keys for bundling and unbundling the module.
        (More on this later.)</td>
      </tr>
    </table>
  </div>

  <h3>A Deeper Example</h3>

  <p>To see some of these items at work, consider the Makefile.PL
  from my X11::Fvwm module on CPAN:</p>

  <p>The X11::Fvwm module provides access to Fvwm, a popular window
  manager for the X11 Window System. The current version of
  X11::Fvwm, 0.4, is based on Fvwm 2.0.45 and is available on the
  CPAN.</p>

  <p><a href="tpj0203-0011a.html">Makefile.PL from
  x11::Fvwm</a>.</p>

  <p>The <tt>require 5.002</tt> ensures that users are running Perl
  5.002 or newer. After the use <tt>ExtUtils::MakeMaker</tt>, the
  <tt>chk_version()</tt> subroutine (adopted from Graham Barr's
  MailTools package) is defined, which checks to see whether a
  package is present and sufficiently recent, printing "ok" if so,
  or a diagnostic message if not: either "not found or the version
  it found but couldn't accept. Unlike the <tt>PREREQ_PM</tt>
  attribute, it doesn't <tt>die()</tt> if the package can't be
  found; it only warns the user that some features might not be
  available. (The return code could also be used to configure some
  parts of the module, if the absence of the package makes this
  appealing.)</p>

  <p>After Tk and X11::Forms are checked, the scripts provided by
  the module are declared, and the mapping from .PL to actual names
  is created. The hash is passed (as a reference) via
  <tt>PL_FILES</tt>. The original list will also be used in the
  definitions for <tt>clean</tt> and <tt>realclean</tt>, and is
  explicitly listed in <tt>EXE_FILES</tt> to ensure delivery into
  the appropriate install directory (<tt>INSTALLSCRIPT</tt>, since
  all four are scripts).</p>

  <p>The <tt>WriteMakefile()</tt> subroutine provides the NAME of
  the module, and the version number for the distribution is
  gleaned from Fvwm.pm. There are no extra libs to be linked, nor
  defines for the C compiler lines. <tt>INSTALLSCRIPT</tt> is
  hard-coded to <i>/usr/local/lib/X11/fvwm2</i> (the default for
  Fvwm 2, but I'm working on making this more flexible), and both
  INC and the attributes for <tt>macro</tt> utilize it. The macro
  attributes define a <i>make</i> macro called <tt>FVWMSRCDIR</tt>
  that the XS code needs in its include path for a few header
  files.</p>

  <p>The two <tt>dist</tt> attributes fine-tune the results of
  <tt>make dist</tt>. <tt>COMPRESS</tt> identifies which
  compression utility to use, and <tt>SUFFIX</tt> identifies the
  suffix for the final filename. (If you specify <tt>COMPRESS</tt>,
  you must also specify <tt>SUFFIX</tt>). Other keys that can be
  used here include <tt>TAR</tt> to specify a <i>tar</i> utility,
  <tt>TARFLAGS</tt> to pass to <i>tar</i>, <tt>SHAR</tt> to define
  the shell archive utility, <tt>PREOP</tt> to define make commands
  to execute before creating the distribution, and <tt>POSTOP</tt>
  to define commands to be run after creating the distribution.
  There's also <tt>DIST_DEFAULT</tt>, which can be one of
  <tt>tardist</tt>, <tt>shdist</tt>, <tt>zipdist</tt> or
  <tt>uutardist</tt>. This defines which action is performed upon
  <tt>make dist</tt>; the default is <tt>tardist</tt>.</p>

  <h3>REALLY Hacking Your Makefile</h3>

  <p>Perhaps this still isn't enough flexibility for you. MakeMaker
  can oblige. Some of the methods used by MakeMaker (in the MM
  class) can be overridden if you provide a method of the same name
  in the MY class. This is the last resort for tailoring your
  Makefile; the documentation for ExtUtils::MM_Unix (the subclass
  of MM that provides UNIX-based methods) encourages those who need
  to write their own methods to mail the MakeMaker authors and let
  them know why MakeMaker wasn't up to snuff. I'll cover some of
  the more common methods that can be overloaded.</p>

  <p>We'll explore a few methods that actually produce chunks of
  text for the resulting Makefile. Most of these take only the
  object reference as an argument and rely on other method calls
  for access to information:</p>

  <div align="center">
    <table cellpadding="2" cellspacing="2" width="400" border="1">
      <tr valign="top">
        <td><i>Method</i></td>

        <td><i>What Does It Do?</i></td>
      </tr>

      <tr valign="top">
        <td><tt>constants</tt></td>

        <td>Produces a code block that defines most of the make
        constants. Most of these pertain to system tools (ar,
        linkers, etc.) and Perl-related version strings and
        paths.</td>
      </tr>

      <tr valign="top">
        <td><tt>dist</tt></td>

        <td>Produces the macros for making the dist targets.</td>
      </tr>

      <tr valign="top">
        <td><tt>macro</tt></td>

        <td>Produces macros derived from the macro attribute passed
        into MakeMaker.</td>
      </tr>

      <tr valign="top">
        <td><tt>post_constants</tt></td>

        <td>Lets the user place override constants immediately
        after MakeMaker executes the constants method.</td>
      </tr>

      <tr>
        <td><tt>postamble</tt></td>

        <td>Allows the user to specify some text for the end of the
        Makefile.</td>
      </tr>
    </table>
  </div>

  <p>There are many more than these five. In the documentation for
  both MakeMaker and the operating-system-specific variants (e.g.
  ExtUtils::MM_Unix.pm, ExtUtils::MM_Win32.pm), the methods that
  can be overridden are marked with an <tt>o</tt>. When overriding
  a method, you simply define it in Makefile.PL like so:</p>
  <pre>
sub MY::post_constants {
   my $self = shift; 
   my @m; 

   push(@m, 
     "PURIFY_DIR = /usr/local/pure/purify/purify-4.0-hpux/\n",
     "PURIFY = $(PURIFY_DIR)/purify\n"); 

   join "", @m; 
} 
</pre>

  <p>Or, if you intend to reference the original method (or any
  other methods from the MM package), use the MY package:</p>
  <pre>
sub MY::constants {
   package MY;   # To help SUPER work right 
   my $self = shift; 
   my @m; 

   push(@m, $self-&gt;SUPER::constants(@_)); 
   push(@m, 
     "PURIFY_DIR = /usr/local/pure/purify/purify-4.0-hpux/\n",
     "PURIFY = $(PURIFY_DIR)/purify\n");

   join "", @m; 
} 
</pre>

  <h3>Simpler Uses</h3>

  <p>MakeMaker is absolutely necessary only when your module
  requires compilation of non-Perl code with XS. But there are
  several reasons why you might want to use MakeMaker even when
  your module is pure, portable Perl:</p>

  <ul>
    <li>Your module consists of several .pm files set up for
    autoloading. You don't want to manually split them, so you have
    MakeMaker do it for you.</li>

    <li>You want your package to be installed into the standard
    area&mdash;wherever that might be. These paths are available to
    MakeMaker using Perl's configuration data.</li>

    <li>Your module requires the presence of other Perl modules,
    and you want to ensure they're available.</li>

    <li>You've got some computation to perform when your module is
    being configured.</li>

    <li>Users are used to installing CPAN modules with <tt>perl
    Makefile.PL</tt> and a <tt>make</tt>. Why surprise them?</li>
  </ul>

  <p>Some examples of Perl-only modules that use MakeMaker include
  my Image::Size (described in <a href=
  "http://www.itknowledge.com/tpj/contents.html#issue6">TPJ
  #6</a>), Graham Barr's MailTools and libnet packages, and Gisle
  Aas' LWP package.</p>

  <h3>MakeMaker and Installation of Modules</h3>

  <p>As mentioned earlier, MakeMaker manages the rules associated
  with installing your module and related files. But where exactly
  are things placed, and can those locations be changed?</p>

  <p>The destination directories for files are based on the file
  type and whether MakeMaker is operating within the Perl source
  tree. The important directories are:</p>

  <div align="center">
    <table cellpadding="2" cellspacing="2" width="400" border="1">
      <tr valign="top">
        <td><i>Directory</i></td>

        <td><i>What's Stored There</i></td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLSITESEARCH</tt></td>

        <td>Architecture-dependent files (such as dynamic
        libraries)</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLSITELIB</tt></td>

        <td>Other library files (such as .pm files)</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLBIN</tt></td>

        <td>Binary executables (used if an extension provides the
        option of creating a new perl with the extension built
        in.)</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLSCRIPT</tt></td>

        <td>Runnable scripts</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLMAN1DIR</tt></td>

        <td>Section 1 manual pages (from scripts or standalone
        pods)</td>
      </tr>

      <tr valign="top">
        <td><tt>INSTALLMAN3DIR</tt></td>

        <td>Section 3 manual pages (from .pm files)</td>
      </tr>
    </table>
  </div>

  <p>Two caveats: First, <tt>INSTALLSITEARCH</tt> and
  <tt>INSTALLSITELIB</tt> assume that you, the module author, want
  the end product to be installed in the site-local area where
  non-core modules are meant to go. If the user prefers to have
  their Perl installation keep all extensions and modules in the
  same place, they can force that by setting <tt>INSTALLDIRS</tt>
  to <tt>perl</tt> when they create the Makefile: <tt>perl
  Makefile.PL INSTALLDIRS=perl</tt>.</p>

  <p>Second, if you explicitly set either <tt>INSTALLSITEARCH</tt>
  or <tt>INSTALLSITELIB</tt>, then <tt>INSTALLDIRS</tt> will take
  precedence. Installation directories are only defined for section
  1 and section 3 manual pages. If you have man pages that belong
  in other sections, you'll have to encode those rules yourself,
  probably by overloading one of the MM methods such as
  <tt>postamble()</tt>.</p>

  <p>For users who want to build MakeMaker-based packages but don't
  have the necessary access to install them, MakeMaker supports the
  use of either <tt>LIB</tt> or <tt>PREFIX</tt> settings on the
  command line. Do <i>not</i> provide them to
  <tt>WriteMakefile()</tt>; it's <tt>LIB</tt> that should dictate
  where the .pm files go: <tt>perl Makefile.PL LIB=~/perl_lib</tt>.
  This causes <tt>~/perl_lib</tt> to be used for all the
  non-architecture-specific files. Architecture-specific files will
  be deposited in <tt>~/perl_lib/$arch</tt>, where <tt>$arch</tt>
  is the configured architecture name (PA-RISC1.1 on my HP/UX
  machine). This affects only the library code, however; it doesn't
  affect any scripts you provide in your package. If the user
  instead sets <tt>PREFIX</tt>, say, with <tt>perl Makefile.PL
  PREFIX=~</tt>, then all of the installation-related values will
  be set relative to <tt>~</tt>. This overloads the configuration
  value <tt>prefix</tt>, which is often something like
  <i>/usr/local</i> or <i>/opt/perl</i>. My home directory is
  <i>/home/tremere/rjray</i>, and my Perl is installed below
  <i>/usr/local</i>.</p>

  <p>For comparison, here are the six installation paths for my
  machine, with and without the <tt>PREFIX=~</tt> override:</p>

  <p><tt>INSTALLSITEARCH</tt><br>
  without <tt>PREFIX</tt>:
  /usr/local/lib/perl5/site_perl/PA-RISC1.1<br>
  with <tt>PREFIX</tt>:
  /home/tremere/rjray/lib/perl5/site_perl/PA-RISC1.1</p>

  <p><tt>INSTALLSITELIB</tt><br>
  without <tt>PREFIX</tt>: /usr/local/lib/perl5/site_perl<br>
  with <tt>PREFIX</tt>: /home/tremere/rjray/lib/perl5/site_perl</p>

  <p><tt>INSTALLBIN</tt><br>
  without <tt>PREFIX</tt>: /usr/local/bin<br>
  with <tt>PREFIX</tt>: /home/tremere/rjray/bin</p>

  <p><tt>INSTALLSCRIPT</tt><br>
  without <tt>PREFIX</tt>: /usr/local/bin<br>
  with <tt>PREFIX</tt>: /home/tremere/rjray/bin</p>

  <p><tt>INSTALLMAN1DIR</tt><br>
  without <tt>PREFIX</tt>: /usr/local/man/man1<br>
  with <tt>PREFIX</tt>: /home/tremere/rjray/man/man1</p>

  <p><tt>INSTALLMAN3DIR</tt><br>
  without <tt>PREFIX</tt>: /usr/local/lib/perl5/man/man3<br>
  with <tt>PREFIX</tt>: /home/tremere/rjray/lib/perl5/man/man3</p>

  <p>Any of these six could be overridden in the call to
  <tt>WriteMakefile()</tt>. For instance, the X11::Fvwm Makefile.PL
  shown earlier overrides <tt>INSTALLSCRIPT</tt> to force the
  scripts into the directory preferred by Fvwm. To look at the
  values from your configuration, try <tt>perl
  '-V:install.*'</tt></p>

  <h3>perllocal.pod</h3>

  <p>You might not have known that Perl keeps a list of the
  packages installed with MakeMaker. Upon successful installation,
  several lines are appended to
  <tt>INSTALLARCHLIB/</tt>perllocal.pod, noting the package that
  was installed, a few details about it, and when the installation
  occurred. A tidy little <i>cron</i> job could give you a
  web-browsable record of what modules have been installed on your
  system. Take a look at perllocal.pod on your system and see
  what's there.</p>

  <p>More detail can be found in the documentation for
  ExtUtils::MakeMaker, your system's MM methods (ExtUtils::MM_Unix
  for me) and <i>h2xs</i>.</p>

  <p>_ _END_ _</p>
  <hr>
  <i>Randy J. Ray has been with the Software Configuration
  Management team as U S WEST Communications since June 1992, where
  he is the lead developer and architect of an SCM system written
  entirely in Perl.</i> <!-- end of article -->
   <!-- end of file -->
</body>
</html>
